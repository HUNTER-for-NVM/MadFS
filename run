#!/usr/bin/env python3

import argparse
import logging
from pathlib import Path

from scripts.runner import Runner
from scripts.utils import check_any_args_passed

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger("run")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Build and run tests or benchmarks")
    parser.add_argument(
        "cmake_target",
        help="see .cpp files in `test` and `bench` for available targets",
    )
    parser.add_argument(
        "build_type",
        nargs=argparse.OPTIONAL,
        help="see Makefile for available build types",
    )
    parser.add_argument(
        "-c",
        "--cmake_args",
        default="",
        help="additional build arguments to be passed to CMake",
    )
    parser.add_argument(
        "-p",
        "--prog_args",
        default="",
        help="arguments to be passed to the program during execution",
    )
    parser.add_argument(
        "-d",
        "--disable_ulayfs",
        action="store_false",
        dest="load_ulayfs",
        help="do not load the ulayfs shared library",
    )
    parser.add_argument("-r", "--result_dir", type=Path, help="result directory")
    parser.add_argument("--numa", type=int, default=0, help="numa node to run on")
    check_any_args_passed(parser)
    args = parser.parse_args()
    logger.debug(f"args={args}")

    runner = Runner(**vars(args))
    runner.build(**vars(args))
    runner.run(**vars(args))
